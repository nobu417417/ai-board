<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>投票掲示板テスト</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding-top: 50px; background-color: #fff5f7; }
        .vote-card { background: white; padding: 20px; border-radius: 15px; display: inline-block; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 2px solid #ffb6c1; }
        h1 { color: #ff69b4; font-size: 1.2rem; }
        .count-display { font-size: 2rem; font-weight: bold; color: #333; margin: 10px 0; }
        button { background-color: #ff69b4; color: white; border: none; padding: 10px 20px; border-radius: 20px; font-size: 1rem; cursor: pointer; transition: 0.3s; }
        button:hover { background-color: #ff1493; }
        button:disabled { background-color: #ccc; }
    </style>
</head>
<body>

    <div class="vote-card">
        <h1>この投稿、どう思う？</h1>
        <div class="count-display" id="voteCountDisplay">0</div>
        <button id="voteBtn">プラス！</button>
    </div>

    <script>
        // --- 設定エリア（ここを書き換えてください） ---
        const SUPABASE_URL = "https://svoovxefpjcuwjpqryut.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2b292eGVmcGpjdXdqcHFyeXV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNDQ3ODIsImV4cCI6MjA4NjcyMDc4Mn0.P0r32dM5e-_g7Fny1OKKUCPUre_rBOhFyiTLUnvya9I";
        const threadId = "main-thread";
        // ------------------------------------------

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // 最新の数値を表示する関数
        async function updateDisplay() {
            const { data, error } = await supabaseClient
                .from("votes")
                .select("score")
                .eq("thread_id", threadId)
                .single();
            
            if (data) {
                document.getElementById("voteCountDisplay").innerText = data.score;
            } else if (error) {
                console.error("データ取得エラー:", error.message);
            }
        }

        // 投票ボタンの処理
        document.getElementById("voteBtn").addEventListener("click", async () => {
            const btn = document.getElementById("voteBtn");
            btn.disabled = true;

            // 1. 現在のスコアを取得
            let { data } = await supabaseClient
                .from("votes")
                .select("*")
                .eq("thread_id", threadId)
                .single();

            if (!data) {
                // 2. データがなければ新規作成
                await supabaseClient.from("votes").insert({ thread_id: threadId, score: 1 });
            } else {
                // 3. データがあれば +1 して更新
                const newScore = (data.score || 0) + 1;
                await supabaseClient
                    .from("votes")
                    .update({ score: newScore })
                    .eq("thread_id", threadId);
            }

            alert("投票完了！");
            await updateDisplay();
            btn.disabled = false;
        });

        // 初回読み込み
        updateDisplay();
    </script>
</body>
</html>
