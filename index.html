<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Vote Test</title>
</head>
<body>

  <h1>Vote Test</h1>
  <button id="voteBtn">投票する</button>

  <!-- Supabase CDN（これ1回だけ） -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <script>
    // =========================
    // Supabase 初期化
    // =========================
    const SUPABASE_URL = "https://svoovxefpjcuwjpqryut.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2b292eGVmcGpjdXdqcHFyeXV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNDQ3ODIsImV4cCI6MjA4NjcyMDc4Mn0.P0r32dM5e-_g7Fny1OKKUCPUre_rBOhFyiTLUnvya9I";

    const supabaseClient = supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY
    );

    // =========================
    // ボタン処理
    // =========================
    document.getElementById("voteBtn").addEventListener("click", async () => {
      console.log("ボタン押された");

      const threadId = "main-thread";

      // ① 既存行チェック
      const { data, error } = await supabaseClient
        .from("votes")
        .select("*")
        .eq("thread_id", threadId)
        .single();

      if (error && error.code !== "PGRST116") {
        console.error("select error:", error);
        return;
      }

      // ② 行が無ければ作成
      if (!data) {
        const { error: insertError } = await supabaseClient
          .from("votes")
          .insert({
            thread_id: threadId,
            count: 1
          });

        if (insertError) {
          console.error("insert error:", insertError);
          return;
        }

        alert("初回投票！");
        return;
      }

      // ③ あれば +1
      const { error: updateError } = await supabaseClient
        .from("votes")
        .update({ count: data.count + 1 })
        .eq("thread_id", threadId);

      if (updateError) {
        console.error("update error:", updateError);
        return;
      }

      alert("投票数：" + (data.count + 1));
    });
  </script>

</body>
</html>
