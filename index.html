<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>AI Board 投票</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<style>
  body { font-family: sans-serif; padding: 20px; }
  #score-display { font-size: 24px; margin-bottom: 10px; }
  button { font-size: 18px; margin-right: 10px; padding: 10px 20px; }
</style>
</head>
<body>

<h1>AI Board 投票</h1>
<div id="score-display">Score: 0</div>
<button id="upvote">+1</button>
<button id="downvote">-1</button>

<script>
  // Supabase プロジェクト情報を入力
  const SUPABASE_URL = 'https://YOUR_PROJECT.supabase.co';
  const SUPABASE_ANON_KEY = 'YOUR_ANON_KEY';

  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const threadId = 'main-thread'; // 固定スレッド
  const scoreDisplay = document.getElementById('score-display');
  const upvoteBtn = document.getElementById('upvote');
  const downvoteBtn = document.getElementById('downvote');

  // --------------------------------
  // スコア取得して画面表示
  // --------------------------------
  async function fetchScore() {
    const { data, error } = await supabase
      .from('votes')
      .select('score')
      .eq('thread_id', threadId)
      .limit(1)
      .maybeSingle();

    if (!error && data) {
      scoreDisplay.textContent = 'Score: ' + data.score;
    } else if (error) {
      console.error('Score取得エラー', error);
    }
  }

  // --------------------------------
  // 投票処理 +1/-1
  // --------------------------------
  async function vote(value) {
    // 1. 現在の score を取得
    const { data, error } = await supabase
      .from('votes')
      .select('score')
      .eq('thread_id', threadId)
      .limit(1)
      .maybeSingle();

    if (error) {
      console.error('Score取得エラー', error);
      return;
    }

    // 2. 新しいスコア計算
    const newScore = (data?.score || 0) + value;

    // 3. 更新
    const { error: updateError } = await supabase
      .from('votes')
      .update({ score: newScore })
      .eq('thread_id', threadId);

    if (updateError) {
      console.error('Score更新エラー', updateError);
      return;
    }

    // 4. 画面更新
    scoreDisplay.textContent = 'Score: ' + newScore;
  }

  // ボタンイベント
  upvoteBtn.addEventListener('click', () => vote(1));
  downvoteBtn.addEventListener('click', () => vote(-1));

  // 初回表示
  fetchScore();

  // --------------------------------
  // Realtime でスコア即時反映
  // --------------------------------
  supabase
    .channel('score_changes')
    .on(
      'postgres_changes',
      { event: 'UPDATE', schema: 'public', table: 'votes' },
      payload => {
        if (payload.new.thread_id === threadId) {
          scoreDisplay.textContent = 'Score: ' + payload.new.score;
        }
      }
    )
    .subscribe();

</script>

</body>
</html>
