<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>AI Board 投票</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
</head>
<body>

<h1>AI Board 投票</h1>

<div id="score-display">Score: 0</div>
<button id="upvote">+1</button>
<button id="downvote">-1</button>

<script>
  // ここに自分の Supabase プロジェクト情報を入力
  const SUPABASE_URL = 'https://YOUR_PROJECT.supabase.co';
  const SUPABASE_ANON_KEY = 'YOUR_ANON_KEY';

  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const threadId = 'main-thread'; // 固定スレッド
  const scoreDisplay = document.getElementById('score-display');
  const upvoteBtn = document.getElementById('upvote');
  const downvoteBtn = document.getElementById('downvote');

  // score を取得して表示
  async function fetchScore() {
    const { data, error } = await supabase
      .from('votes')
      .select('score')
      .eq('thread_id', threadId)
      .limit(1)
      .single();

    if (!error && data) {
      scoreDisplay.textContent = 'Score: ' + data.score;
    }
  }

  // 投票処理
  async function vote(value) {
    // votes に新しい行を追加
    await supabase.from('votes').insert([{ thread_id: threadId, value }]);

    // score を更新
    await supabase
      .from('votes')
      .update({ score: supabase.literal(`score + ${value}`) })
      .eq('thread_id', threadId);

    fetchScore();
  }

  upvoteBtn.addEventListener('click', () => vote(1));
  downvoteBtn.addEventListener('click', () => vote(-1));

  // 初回表示
  fetchScore();

  // Realtime で score の変更を即時反映
  supabase
    .channel('score_changes')
    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'votes' }, payload => {
      if (payload.new.thread_id === threadId) {
        scoreDisplay.textContent = 'Score: ' + payload.new.score;
      }
    })
    .subscribe();
</script>

</body>
</html>
